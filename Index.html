<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réserver - Le Petit Bistrot</title>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">

    <div id="app" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
        <h1 class="text-2xl font-bold mb-2 text-gray-800">Réserver une table</h1>
        <p class="text-gray-500 mb-6 text-sm">Empreinte bancaire requise (aucun débit).</p>

        <div v-if="step === 1">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Votre Nom</label>
                    <input v-model="form.name" type="text" class="mt-1 block w-full p-2 border rounded-md" placeholder="Jean Dupont">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Date</label>
                        <input v-model="form.date" type="date" class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Heure</label>
                        <select v-model="form.time" class="mt-1 block w-full p-2 border rounded-md bg-white">
                            <option>19:30</option>
                            <option>20:00</option>
                            <option>20:30</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nombre de personnes</label>
                    <input v-model.number="form.pax" type="number" min="1" class="mt-1 block w-full p-2 border rounded-md">
                </div>
                <button @click="initiateBooking" :disabled="loading" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">
                    {{ loading ? 'Chargement...' : 'Continuer' }}
                </button>
            </div>
        </div>

        <div v-show="step === 2">
            <div id="payment-element" class="mb-4"></div>
            <button @click="confirmBooking" :disabled="processing" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 font-bold">
                {{ processing ? 'Validation...' : 'Valider l\'empreinte' }}
            </button>
            <button @click="step = 1" class="w-full mt-2 text-gray-500 text-sm hover:underline">Retour</button>
        </div>

        <div v-if="step === 3" class="text-center">
            <div class="text-5xl mb-4">✅</div>
            <h2 class="text-xl font-bold text-gray-800">Réservation Confirmée !</h2>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        // ⚠️ METS TA CLÉ PUBLIQUE STRIPE ICI (pk_test_...)
        const stripe = Stripe('pk_test_TA_CLE_ICI'); 

        createApp({
            data() {
                return {
                    step: 1, loading: false, processing: false, elements: null, clientSecret: null,
                    form: { restaurant_id: 1, name: '', date: '', time: '20:00', pax: 2 }
                }
            },
            methods: {
                async initiateBooking() {
                    this.loading = true;
                    try {
                        const response = await fetch('/create-deposit', { // Note le chemin relatif
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(this.form)
                        });
                        const data = await response.json();
                        this.clientSecret = data.clientSecret;
                        this.elements = stripe.elements({ clientSecret: this.clientSecret });
                        const paymentElement = this.elements.create('payment');
                        paymentElement.mount('#payment-element');
                        this.step = 2;
                    } catch (error) { alert("Erreur serveur"); console.error(error); } finally { this.loading = false; }
                },
                async confirmBooking() {
                    this.processing = true;
                    const { error } = await stripe.confirmPayment({
                        elements: this.elements,
                        confirmParams: { return_url: window.location.href },
                        redirect: "if_required"
                    });
                    if (error) { alert(error.message); this.processing = false; } else { this.step = 3; this.processing = false; }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
